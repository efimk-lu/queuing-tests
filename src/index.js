const fetch = require("node-fetch");
const fs = require("fs");

function getRandomInt(max) {
  return Math.floor(Math.random() * Math.floor(max));
}

let globalCount = 0;
const randomFileName = `result${getRandomInt(100000000000000)}.csv`;
function infiniteSend(url, shouldWriteToFile) {
  setTimeout(() => {
    const localSentTime = Date.now();
    fetch(url, {
      method: "POST",
      body: JSON.stringify({
        sentTime: localSentTime,
        big:
          "111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"
      }),
      headers: { "Content-Type": "application/json" }
    })
      .then(() => {
        process.stdout.write(".");
        if (shouldWriteToFile) {
          data = `${Date.now() - localSentTime}\n`;
          fs.appendFileSync(randomFileName, data, "utf8");
        }
        globalCount++;
      })
      .catch(err => {
        console.error(err);
      });
    infiniteSend(url, shouldWriteToFile);
  }, 5);
}

if (process.argv.length < 3) {
  console.error("Missing url name");
  process.exit();
}
const startTime = Date.now();
process.on("SIGINT", function() {
  console.log("Caught interrupt signal");
  const timePassed = (Date.now() - startTime) / 1000;
  console.info(`On average ${globalCount / timePassed}`);
  process.exit();
});

infiniteSend(process.argv[2], process.argv[3] === "true");
